#!/usr/bin/env bash
set -euo pipefail

err_report() {
	echo "ERROR: ${0} failed on line ${1}"
}
trap 'err_report ${LINENO}' ERR

# kubelet default
max_pods=110

{{- if eq .Values.global.connectivity.cilium.ipamMode "eni" }}

imds_token="$(curl -fsS -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 900")" \
	|| { echo "ERROR: Failed to get IMDSv2 token from EC2 metadata service"; exit 1; }
instance_type="$(curl -fsS --max-time 10 -H "X-aws-ec2-metadata-token: ${imds_token}" http://169.254.169.254/latest/meta-data/instance-type)" \
	|| { echo "ERROR: Failed to query instance type from EC2 metadata service"; exit 1; }

# First ENI is reserved for the node (see https://github.com/giantswarm/cilium-app/blob/main/helm/cilium/templates/cilium-cni-configmap.yaml
# for how Giant Swarm configures Cilium ENI mode with CAPA clusters)
reserved_eni=1

# Maximum number of pods is defined by maximum ENIs per instance and maximum IPs per ENI
# (https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html). Continue below to set `--max-pods`.
case "${instance_type}" in
# TO UPDATE THESE CASES, USE THE FOLLOWING COMMAND:
#     aws ec2 describe-instance-types --query "InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}" --output json | jq -er '.[] | "\(.Type)) max_pods=$(((\(.MaxENI)-$reserved_eni)*(\(.IPv4addr)-1))) ;;"' | sort
#
# AUTO-GENERATED USING THE ABOVE COMMAND, DO NOT EDIT MANUALLY - START
c4.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c4.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c4.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c4.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c4.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5.18xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5.9xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c5.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5a.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5a.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5a.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5a.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5a.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5a.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5a.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c5a.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5d.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5d.18xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5d.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5d.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5d.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5d.9xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5d.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c5d.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5d.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5n.18xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5n.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c5n.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5n.9xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c5n.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c5n.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c5n.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6a.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6a.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6a.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6a.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6a.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6a.48xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6a.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6a.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6a.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c6a.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6a.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6g.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6g.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6g.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6g.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6g.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6g.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c6g.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
c6g.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6g.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6gd.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6gd.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6gd.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6gd.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6gd.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6gd.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c6gd.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
c6gd.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6gd.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6gn.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6gn.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6gn.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6gn.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6gn.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6gn.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c6gn.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
c6gn.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6i.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6i.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6i.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6i.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6i.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6i.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6i.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6i.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c6i.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6i.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6id.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6id.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6id.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6id.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6id.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6id.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6id.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6id.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c6id.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6id.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6in.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6in.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6in.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c6in.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c6in.32xlarge) max_pods=$(((16-$reserved_eni)*(50-1))) ;;
c6in.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6in.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c6in.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c6in.metal) max_pods=$(((16-$reserved_eni)*(50-1))) ;;
c6in.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c7g.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7g.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c7g.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c7g.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7g.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7g.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c7g.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
c7g.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c7g.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c7i-flex.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c7i-flex.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7i-flex.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7i-flex.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c7i-flex.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c7i.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7i.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c7i.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c7i.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
c7i.48xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c7i.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7i.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
c7i.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
c7i.metal-24xl) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c7i.metal-48xl) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
c7i.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
d2.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
d2.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
d2.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
d2.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
d3.2xlarge) max_pods=$(((4-$reserved_eni)*(5-1))) ;;
d3.4xlarge) max_pods=$(((4-$reserved_eni)*(10-1))) ;;
d3.8xlarge) max_pods=$(((3-$reserved_eni)*(20-1))) ;;
d3.xlarge) max_pods=$(((4-$reserved_eni)*(3-1))) ;;
f1.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
f1.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g3.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
g3.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g3.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g3s.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
g4ad.16xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g4ad.2xlarge) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
g4ad.4xlarge) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
g4ad.8xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
g4ad.xlarge) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
g4dn.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g4dn.16xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
g4dn.2xlarge) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
g4dn.4xlarge) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
g4dn.8xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
g4dn.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
g4dn.xlarge) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
g5.12xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
g5.16xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g5.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
g5.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
g5.48xlarge) max_pods=$(((7-$reserved_eni)*(50-1))) ;;
g5.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g5.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
g5.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
i3.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
i3.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
i3.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
i3.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
i3.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
i3.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
i3.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
i3en.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
i3en.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
i3en.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
i3en.3xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
i3en.6xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
i3en.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
i3en.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
i3en.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
i4i.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
i4i.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
i4i.24xlarge) max_pods=$(((15-$reserved_eni)*(30-1))) ;;
i4i.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
i4i.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
i4i.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
i4i.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
i4i.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
i4i.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
i4i.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
im4gn.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
im4gn.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
im4gn.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
im4gn.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
im4gn.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
im4gn.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
inf1.24xlarge) max_pods=$(((11-$reserved_eni)*(30-1))) ;;
inf1.2xlarge) max_pods=$(((4-$reserved_eni)*(10-1))) ;;
inf1.6xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
inf1.xlarge) max_pods=$(((4-$reserved_eni)*(10-1))) ;;
inf2.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
inf2.48xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
inf2.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
inf2.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
is4gen.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
is4gen.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
is4gen.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
is4gen.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
is4gen.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
is4gen.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m4.10xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m4.16xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m4.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m4.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m4.large) max_pods=$(((2-$reserved_eni)*(10-1))) ;;
m4.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m5.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5a.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5a.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5a.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5a.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5a.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5a.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5a.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m5a.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5ad.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5ad.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5ad.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5ad.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5ad.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5ad.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5ad.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m5ad.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5d.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5d.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5d.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5d.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m5d.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5d.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m5d.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m5d.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m5d.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6a.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6a.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6a.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6a.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6a.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6a.48xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6a.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6a.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6a.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m6a.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6a.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6g.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6g.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6g.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6g.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6g.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6g.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m6g.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
m6g.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6g.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6gd.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6gd.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6gd.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6gd.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6gd.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6gd.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m6gd.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
m6gd.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6gd.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6i.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6i.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6i.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6i.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6i.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6i.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6i.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6i.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m6i.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6i.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6id.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6id.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6id.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6id.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m6id.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6id.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6id.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m6id.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m6id.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m6id.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m7g.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7g.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m7g.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m7g.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7g.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7g.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m7g.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
m7g.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m7g.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m7i-flex.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m7i-flex.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7i-flex.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7i-flex.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m7i-flex.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m7i.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7i.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m7i.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m7i.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
m7i.48xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m7i.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7i.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
m7i.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
m7i.metal-24xl) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m7i.metal-48xl) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
m7i.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
mac1.metal) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
p3.16xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
p3.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
p3.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r4.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r4.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r4.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r4.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r4.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r4.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r5.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5a.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5a.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5a.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5a.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5a.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5a.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5a.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r5a.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5ad.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5ad.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5ad.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5ad.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5ad.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5ad.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5ad.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r5ad.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5b.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5b.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5b.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5b.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5b.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5b.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5b.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r5b.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5b.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5d.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5d.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5d.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5d.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5d.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5d.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5d.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r5d.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5d.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5n.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5n.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5n.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5n.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r5n.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5n.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r5n.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r5n.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r5n.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6g.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6g.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6g.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6g.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6g.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6g.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r6g.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
r6g.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6g.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6gd.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6gd.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6gd.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6gd.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6gd.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6gd.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r6gd.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
r6gd.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6gd.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6i.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6i.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6i.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6i.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6i.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6i.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6i.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6i.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r6i.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6i.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6id.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6id.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6id.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6id.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r6id.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6id.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6id.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r6id.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r6id.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r6id.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r7g.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r7g.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r7g.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r7g.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r7g.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r7g.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r7g.medium) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
r7g.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r7g.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r7i.12xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r7i.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r7i.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r7i.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
r7i.48xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r7i.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r7i.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
r7i.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
r7i.metal-24xl) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r7i.metal-48xl) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
r7i.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
t2.2xlarge) max_pods=$(((3-$reserved_eni)*(15-1))) ;;
t2.large) max_pods=$(((3-$reserved_eni)*(12-1))) ;;
t2.medium) max_pods=$(((3-$reserved_eni)*(6-1))) ;;
t2.micro) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t2.nano) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t2.small) max_pods=$(((3-$reserved_eni)*(4-1))) ;;
t2.xlarge) max_pods=$(((3-$reserved_eni)*(15-1))) ;;
t3.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
t3.large) max_pods=$(((3-$reserved_eni)*(12-1))) ;;
t3.medium) max_pods=$(((3-$reserved_eni)*(6-1))) ;;
t3.micro) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t3.nano) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t3.small) max_pods=$(((3-$reserved_eni)*(4-1))) ;;
t3.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
t3a.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
t3a.large) max_pods=$(((3-$reserved_eni)*(12-1))) ;;
t3a.medium) max_pods=$(((3-$reserved_eni)*(6-1))) ;;
t3a.micro) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t3a.nano) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t3a.small) max_pods=$(((2-$reserved_eni)*(4-1))) ;;
t3a.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
t4g.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
t4g.large) max_pods=$(((3-$reserved_eni)*(12-1))) ;;
t4g.medium) max_pods=$(((3-$reserved_eni)*(6-1))) ;;
t4g.micro) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t4g.nano) max_pods=$(((2-$reserved_eni)*(2-1))) ;;
t4g.small) max_pods=$(((3-$reserved_eni)*(4-1))) ;;
t4g.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
u-6tb1.112xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
u-6tb1.56xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
u-9tb1.112xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x1.16xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
x1.32xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
x2idn.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2idn.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2idn.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2idn.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2iedn.16xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2iedn.24xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2iedn.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
x2iedn.32xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2iedn.4xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
x2iedn.8xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
x2iedn.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
x2iedn.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
z1d.12xlarge) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
z1d.2xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
z1d.3xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
z1d.6xlarge) max_pods=$(((8-$reserved_eni)*(30-1))) ;;
z1d.large) max_pods=$(((3-$reserved_eni)*(10-1))) ;;
z1d.metal) max_pods=$(((15-$reserved_eni)*(50-1))) ;;
z1d.xlarge) max_pods=$(((4-$reserved_eni)*(15-1))) ;;
# AUTO-GENERATED USING THE ABOVE COMMAND, DO NOT EDIT MANUALLY - END
*)
	max_pods=40
	echo "WARNING: EC2 instance type '${instance_type}' is not covered in ${0}, defaulting to max_pods=${max_pods}"
	;;
esac

{{- end }}

# max pods can't be greater than the number of available IPs in nodeCidrMaskSize
node_cidr_mask_size="{{ required "global.connectivity.network.pods.nodeCidrMaskSize is required" .Values.global.connectivity.network.pods.nodeCidrMaskSize }}"
available_ips=$((2 ** (32 - node_cidr_mask_size) - 2))
if (($max_pods > $available_ips)); then
	max_pods=$available_ips
fi

# We don't want to have more than 110 pods on a node even it would be possible by IPs
if (($max_pods > 110)); then
	max_pods=110
fi

# Use a unique suffix so this can't accidentaly use the same patch filenames as the `cluster` chart.
cat > /tmp/kubeletconfiguration1awsconfig+json.yaml <<EOF
- op: replace
  path: /maxPods
  value: ${max_pods}
EOF
mv /tmp/kubeletconfiguration1awsconfig+json.yaml /etc/kubernetes/patches/kubeletconfiguration1awsconfig+json.yaml
