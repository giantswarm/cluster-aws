{{/*
Pre-upgrade hook to safely migrate AWS-specific default apps from App CRs to HelmReleases.

Phase 1 (WC Charts clean up):
  - Pause non-bundle App CRs and discovered bundle sub-App CRs
  - Clean up their WC Chart CRs (pause + remove finalizers + delete)
  - Remove finalizers + delete the paused App CRs

Phase 2 (MC cleanup via operator cascade):
  - Delete bundle App CRs (inCluster: true) without removing finalizers
  - app-operator cascade-deletes the MC Chart CRs in giantswarm namespace
  - chart-operator helm-uninstalls the bundles (sub-Apps already gone)

Flux then adopts the existing Helm releases via the new HelmRelease CRs.

Note: The cluster subchart has its own migration hook for generic apps.
This hook handles only AWS-specific apps.
*/}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "resource.default.name" $ }}-migrate-aws-apps
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "labels.common" $ | nindent 4 }}
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "labels.common" $ | nindent 8 }}
    spec:
      serviceAccountName: {{ include "resource.default.name" $ }}-migrate-aws-apps
      restartPolicy: Never
      containers:
      - name: kubectl
        image: gsoci.azurecr.io/giantswarm/kubectl:{{ .Values.cluster.providerIntegration.kubernetesVersion }}
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
            - ALL
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 512Mi
        command:
        - /bin/sh
        - -c
        - |
          set -eu
          CLUSTER_NAME="{{ include "resource.default.name" $ }}"
          NAMESPACE="{{ $.Release.Namespace }}"
          CHART_NAMESPACE="giantswarm"

          # Fetch WC kubeconfig
          echo "Fetching WC kubeconfig for $CLUSTER_NAME"
          kubectl get secret -n "$NAMESPACE" "${CLUSTER_NAME}-kubeconfig" \
            -o jsonpath='{.data.value}' | base64 -d > /tmp/wc-kubeconfig

          WC="--kubeconfig /tmp/wc-kubeconfig"

          # Helper: remove finalizers and delete an App CR.
          delete_app() {
            local app_name="$1"

            if ! kubectl get apps.application.giantswarm.io "$app_name" -n "$NAMESPACE" > /dev/null 2>&1; then
              echo "  App CR $app_name not found, skipping"
              return
            fi

            echo "  Removing finalizers from App CR $app_name"
            kubectl patch apps.application.giantswarm.io "$app_name" -n "$NAMESPACE" --type=json \
              -p='[{"op": "remove", "path": "/metadata/finalizers"}]' 2>/dev/null || \
              echo "  No finalizers to remove or already deleted"

            echo "  Deleting App CR $app_name"
            kubectl delete apps.application.giantswarm.io "$app_name" -n "$NAMESPACE" --ignore-not-found=true
          }

          # Helper: pause, remove finalizers, and delete a WC Chart CR.
          # The paused annotation prevents chart-operator from re-adding
          # its finalizer (race condition) and from uninstalling the Helm release.
          cleanup_wc_chart() {
            local chart_name="$1"

            if ! kubectl $WC get chart "$chart_name" -n "$CHART_NAMESPACE" > /dev/null 2>&1; then
              echo "  Chart CR $chart_name not found on WC, skipping"
              return
            fi

            echo "  Pausing chart-operator reconciliation for $chart_name on WC"
            kubectl $WC annotate chart "$chart_name" -n "$CHART_NAMESPACE" \
              "operatorkit.giantswarm.io/paused=true" --overwrite 2>/dev/null || \
              echo "  Failed to pause, continuing anyway"

            echo "  Removing finalizers from Chart CR $chart_name on WC"
            kubectl $WC patch chart "$chart_name" -n "$CHART_NAMESPACE" --type=json \
              -p='[{"op": "remove", "path": "/metadata/finalizers"}]' 2>/dev/null || \
              echo "  No finalizers to remove or already deleted"

            echo "  Deleting Chart CR $chart_name on WC"
            kubectl $WC delete chart "$chart_name" -n "$CHART_NAMESPACE" --ignore-not-found=true
          }

          # Bundle apps (inCluster: true) - MC Chart CRs cleaned up via
          # operator cascade in Phase 2.
          BUNDLE_APPS="
            aws-nth-bundle
            cert-manager-crossplane-resources
            cilium-crossplane-resources
          "

          # Non-bundle apps managed by this chart
          NON_BUNDLE_APPS="
            ${CLUSTER_NAME}-aws-pod-identity-webhook
            ${CLUSTER_NAME}-aws-ebs-csi-driver-smons
            ${CLUSTER_NAME}-irsa-servicemonitors
          "

          # WC Chart CR names for non-bundle apps (cluster prefix stripped)
          NON_BUNDLE_WC_CHARTS="
            aws-pod-identity-webhook
            aws-ebs-csi-driver-smons
            irsa-servicemonitors
          "

          # Helper: run cleanup_wc_chart in batches to avoid OOM
          BATCH_MAX=6
          batch_cleanup_wc_charts() {
            local count=0
            for chart_name in "$@"; do
              chart_name=$(echo "$chart_name" | tr -d '[:space:]')
              [ -z "$chart_name" ] && continue
              cleanup_wc_chart "$chart_name" &
              count=$((count + 1))
              if [ $count -ge $BATCH_MAX ]; then
                wait || true
                count=0
              fi
            done
            wait || true
          }

          # ============================================================
          # Phase 1: Pause all App CRs and clean up WC Chart CRs
          # ============================================================
          # Operations are batched-parallel to complete within
          # chart-operator's 5-minute Helm timeout without OOM.

          # 1a. Pause non-bundle App CRs
          echo "Phase 1a: Pausing non-bundle App CRs"
          for APP_CR in $NON_BUNDLE_APPS; do
            APP_CR=$(echo "$APP_CR" | tr -d '[:space:]')
            [ -z "$APP_CR" ] && continue
            kubectl annotate apps.application.giantswarm.io "$APP_CR" -n "$NAMESPACE" \
              "operatorkit.giantswarm.io/paused=true" --overwrite 2>/dev/null || true
          done

          # 1b. Discover bundle sub-App CRs and pause them
          echo "Phase 1b: Discovering and pausing bundle sub-App CRs"
          ALL_SUB_APPS=""
          SUB_APP_WC_CHARTS=""
          for BUNDLE in $BUNDLE_APPS; do
            BUNDLE=$(echo "$BUNDLE" | tr -d '[:space:]')
            [ -z "$BUNDLE" ] && continue
            BUNDLE_FULL="${CLUSTER_NAME}-${BUNDLE}"
            echo "  Discovering sub-apps of $BUNDLE_FULL"
            SUB_APPS=$(kubectl get apps.application.giantswarm.io -n "$NAMESPACE" \
              -o jsonpath='{range .items[*]}{.metadata.annotations.meta\.helm\.sh/release-name}={.metadata.name}{"\n"}{end}' 2>/dev/null \
              | grep "^${BUNDLE_FULL}=" | cut -d= -f2) || true

            for SUB_APP in $SUB_APPS; do
              [ -z "$SUB_APP" ] && continue
              ALL_SUB_APPS="$ALL_SUB_APPS $SUB_APP"
              SUB_APP_WC_CHARTS="$SUB_APP_WC_CHARTS ${SUB_APP#${CLUSTER_NAME}-}"
              kubectl annotate apps.application.giantswarm.io "$SUB_APP" -n "$NAMESPACE" \
                "operatorkit.giantswarm.io/paused=true" --overwrite 2>/dev/null || true
            done
          done

          # 1c. Clean up ALL WC Chart CRs (batched parallel)
          echo "Phase 1c: Cleaning up WC Chart CRs"
          batch_cleanup_wc_charts $SUB_APP_WC_CHARTS $NON_BUNDLE_WC_CHARTS

          # 1d. Delete non-bundle App CRs and sub-App CRs
          echo "Phase 1d: Deleting App CRs"
          for APP_CR in $NON_BUNDLE_APPS $ALL_SUB_APPS; do
            APP_CR=$(echo "$APP_CR" | tr -d '[:space:]')
            [ -z "$APP_CR" ] && continue
            delete_app "$APP_CR"
          done

          # ============================================================
          # Phase 2: MC cleanup via operator cascade
          # ============================================================
          # Delete bundle App CRs without removing finalizers.
          # app-operator (not paused) will cascade-delete the MC Chart CRs,
          # and chart-operator will helm-uninstall the bundles. The sub-App
          # CRs were already deleted in Phase 1, so the uninstall succeeds.
          echo "Phase 2: Deleting bundle App CRs (operators will clean up MC Chart CRs)"
          for BUNDLE in $BUNDLE_APPS; do
            BUNDLE=$(echo "$BUNDLE" | tr -d '[:space:]')
            [ -z "$BUNDLE" ] && continue
            BUNDLE_APP="${CLUSTER_NAME}-${BUNDLE}"
            kubectl delete apps.application.giantswarm.io "$BUNDLE_APP" -n "$NAMESPACE" \
              --ignore-not-found=true --wait=false 2>/dev/null || true
          done

          echo "AWS migration hook completed successfully"
